# Implemented IDPay payment documentation library
# کتابخانه پیاده سازی شده مستندات پرداخت IDPay
این کتابخانه یک کتابخانه بیسیک برای استفاده راحت تر از مستندات پرداخت درگاه پرداخت IDPay می باشد. در ادامه کل توابع که برای استفاده از این کتابخه برای شما شرح داده می شود.

راهنمای نصب

```python
pip install idpay
```

راهنمای فراخوانی

```python
from idpay import idpay
```


این کتابخانه با استفاده از متود های شی گرایی پایتون نوشته شده است پس برای استفاده از این کتابخانه نیاز به تنظیمات اولیه دارد که می توانید برای ست کردن تنظیم اولیه باید ابتدا چند مقدار اولیه را به نرم افزار بدهید.

1. مقدار API KEY (که باید از قسمت پروفایل کاربری / وب سرویس های من کپی کرده و در کد قرار دهید.)
2. مقدار X-SANDBOX که به صورت Boolean یا همان متغییر False یا True بوده و بیانگر حالت استفاده از درگاه پرداخت به صورت آزمایشی یا در حالت واقعی است.
3. حالت سوم به صورت کاملا ثابت می باشد که مقدار application/json را دارد که بیان گر حالت دریافت/ارسال اطلاعات و پارامتر ها به صورت رشته Json است. 
برای نمونه مثال های بالا کد زیر را در نظر بگیرید:
```python
id = idpay("6a7f99eb-7c20-4412-a972-6dfb7cd253a4", "http://localhost:8000/")
```
توضیح کد بالا :
کد بالا یک تابع __init__ را از کلاس اصلی idpay فراخانی می کند و در قسمت اول ورودی X-API-KEY و در قسمت دوم آدرس Callback که هم در درگاه پرداخت خود در پنل مدیریت پروفایل idpay را ثبت کرده اید پاس می دهد.
در این کتابخانه حالت آزمایشی به صورت دیفالت بر روی کتابخانه True قراردارد و اگر می خواهید حالت آن را به False تغییر دهید می توانید از قطعه کد زیر استفاده کنید :
```python
id = idpay("6a7f99eb-7c20-4412-a972-6dfb7cd253a4", "http://localhost:8000/", sandbox = False)
```
======
## تابع پرداخت
در اولین مرحله از ثبت اطلاعات سبد خرید باید ابتدا یک تراکنش را ایجاد کنید، ابتدا برای ایجاد تراکنش به صورت خودکار باید تنظیمات مرحله اول را به درستی انجام داده باشید سپس برای ایجاد یک تراکنش باید مقدار های زیر را به تابع payment از کلاس idpay پاس دهید.

نکته : همه مقدار های گفته شده در زیر ضروری نیستند و شما می توانید فقط مقدار های ضروری را به سمت سرور برای ایجاد تراکنش پاس دهید.

نکته 2 : مقدار های ضروری حتما باید به صورت صحیح به تابع اصلی پاس داده شوند.
```
*"order_id": شماره سفارشی که از سبد خرید باید پاس داده شود
*"amount": قیمت کل سبد خرید به صورت جمع خورده
"name" : نام پرداخت کننده
"phone" : شماره موبایل پرداخت کننده 
"mail" : ایمیل ادرس پرداخت کننده
"desc" : توضیحات که این تراکنش به خود اختصاص می دهد.
*"callback": آدرس صفحه ای که بعد از ثبت تراکنش به صورت موفق به آن وب سرویس ریدایرکت می شود.
```
توضیح مقدار کد بالا :

نکته : در کد بالا مقدار Order_id , Amount  و Callback حتما برای ساخت یک تراکنش ضروری هستند و باید به تابع Payment پاس داده شوند.


نکته 2 : آدرسی که برای Callback در نظر می گیرید حتما باید یک وبسرویس فعال باشد، اگر در حالت آزمایشی می خواهید یک تراکنش را تست کنید می توانید از localhost استفاده کنید اما اگر در حالت واقعی در حال ساخت یک تراکنش واقعی در درگاه بانکی هستید حتما باید یک آدرس وبسرویس فعال داشته باشید و حتما این ادرس وبسرویس شما باید در قسمت ( وب سرویس های من) در صفحه پروفایل شما قرار داشته باشد. 


بعد از در نظر گرفتن توضیحات بالا با استفاده از قطعه کد زیر یک تراکنش را ایجاد می کنید :

```python
id = idpay("6a7f99eb-7c20-4412-a972-6dfb7cd253a4", "http://localhost:8000/")
id.payment(1200 ,1000, 'dashboard')
```

توضیح کد بالا :

در خط اول کد طبق توضیحات قبلی که دادیم، متغییر X-API-KEY را برای ارسال به تنظیمات اصلی پاس دادیم و در قسمت دوم ادرس اصلی که در قسمت وب سرویس های من بوده را به تنظیمات کلاس پاس دادیم. در قسمت سوم می توانیم کل کلاس را به صورت حالت آزمایشی و یا در حالت واقعی تنظیم کنیم که اگر می خواهید تراکنش در حالت واقعی اتفاق بیوفتد باید قطعه کد بالا را به صورت زیر تنظیم کنید.

```python
id = idpay("6a7f99eb-7c20-4412-a972-6dfb7cd253a4", "http://localhost:8000/", sandbox = False)
id.payment(1200 ,1000, 'dashboard')
```

بعد از اجرا کد بالا باید یک خروجی مشابه خروجی زیر دریافت کنید :
```
Payment Successful
{'id': 'b5bbc2808e30e1169b3661a30cf9d41b', 'link': 'https://idpay.ir/p/ws-sandbox/b5bbc2808e30e1169b3661a30cf9d41b'}
```

در خروجی بالا دقت داشته باشید که رشته json حاوی مقادیر id , Link برای شما برگردانده میشوند.

توضیحات : 

در قطعه کد بالا رشته id که برای شما برگردانده می شود باید در دیتابیس خود ذخیره کرده تا بتوانید در مراحل احراز هویت اصلی تابع Callback که در ادامه به توضیح این تابع می رسیم انجام دهید.

id : یک رشته حاوی حروف و اعداد می باشد که به صورت یکتا برای احراز هویت تراکنش شما در دست شما قرار خواهد گرفت.

link : لینک هم به صورت کاملا یکتا می باشد که نشان دهنده ساخت شدن تراکنش شما از سمت سرور است و شما رو در ادامه روند پرداخت کمک خواهد کرد.

نکته مهم :

بعد از اینکه تراکنش شما ساخته شد شما حتما باید وارد لینک که از طرف سرور برای شما ارسال می شود شوید و سپس اگر در حالت آزمایشی قراردارید بر روی در انتظار تایید پرداخت کلیک کنید.


![alt text](https://raw.githubusercontent.com/Pythoniha/IDPay-Basic/main/screen/idpay.jpg "Logo Title Text 1")

شما بعد از انجام مراحل بالا می توانید تابع Callback را فراخوانی کرده تا سرور از صحت اطلاعات شما به مطمعن شود. تابع Callback ورودی های زیر را دریافت می کند.

```python
idpay.callback(satuts_code, order_id_db, transaction_id_db, order_id_server, id_server)
```

توضیح قطعه تابع بالا :

برای اینکه ورودی های درستی به تابع Callback پاس داده شوند، ابتدا نیاز است اطالاعاتی که از قسمت Payment برای ما برگشت داده شده اند را در دیتابیس خود ذخیره کنیم همچنین اطلاعات که در این خط کد برای ساخت یک تراکنش نیاز بوده را باید در دیتابیس خود ذخیره کرده تا بتوانید همان اطلاعات را در تابع Callback استفاده کنیم.

به صورت مثال اطلاعات شماره سفارش که در قسمت ساخت یک تراکنش Order_id ارسال کردیم.

و شماره id که بعد از ساخت تراکنش برای ما برگشت خورده حتما باید در تابع Callback فراخوانی و به صورت یک ورودی به این تابع پاس داده شود.

به صورت مثال ما یک Callback برای سرور ارسال می کنید :

```python
idpay.callback(10, 1200, b5bbc2808e30e1169b3661a30cf9d41b, 12, b5bbc2808e30e1169b3661a30cf9d41b)
```
بعد از صحت سنجی اطلاعات داخل سرور و دیتابیس و راستی آزمایی کد ها اطلاعات تراکنش شما به صورت خودکار از تابع داخلی Verify استفاده خواهد کرد که نیاز به تنظیم آن نیست و اگر اطلاعات ب صورت ناقص به سمت سرور ارسال شود. تابع Verify فعال نمیشود.

نکته اول : اگر شما در حالت واقعی و یا مشتریان شما در حال واقعی یک تراکنش را انجام دهند و تابع Verify فعال نشود و پول از حساب مشتریان کسر شود تا 72 ساعت آینده به حساب این مشتریان واریز می شود.

نکته 2 : اگر تمامی مراحل به صورت درست اعمال شود و اطلاعات به سمت سرور ارسال شود و تابع Callback صحت سنجی این اطلاعات را راستی آزمایی کند و سپس تابع Verify بدون ارور اجرا شود پول به حساب درگاه بانکی شما واریز شده و دیگر هیچ اروری دریافت نخواهیدکرد اما شما تا قبل از حداقل 10 دقیقه پس از انجام تراکنش می توانید عمل Verify کردن حساب را انجام دهید و اگر این مدت زمان بگذرد پول دوباره به حساب مشتری برگشت خواهد خورد.


نمونه کد های کامل برای استفاده صحیح از کتابخانه

```python
id = idpay("6a7f99eb-7c20-4412-a972-6dfb7cd253a4", "http://localhost:8000/")
id.payment(1200 ,1000, 'dashboard')
questions = input('Aya Link Ra Moshahede Kardid ?[Yes | No ]').lower()
if questions == 'no':
    print('Pass Dobare Link Morede Nazar Ra baraye Shoma Ersam mikonam Ta Pardakht Ra anjam dahid !')
elif questions == 'yes':
    print('Montazere Tayid Pardakht Bashid !')

status_code_khod = input('Status Code : ')
order_id_dakhele_database = input('Order ID Dakhele Data Base Ra vared konid : ')
trans_action_dakhele_db = input('Transaction Dakhele Data Base Ra vared konid : ')
order_id_server_online = input('order id server Ra vared konid : ')
trans_action_server = input('Trasnaction server Ra vared konid : ')


idpay.callback(int(status_code_khod), order_id_dakhele_database, trans_action_dakhele_db, order_id_server_online, trans_action_server)
```



[Help IDPay API](https://idpay.ir/web-service/v1.1/)
